From 3ad7021f052e53cab2b6b01f6c6d08b86a5bbe76 Mon Sep 17 00:00:00 2001
From: mattip <matti.picus@gmail.com>
Date: Thu, 5 Dec 2024 11:18:25 +0200
Subject: [PATCH 01/10] patch redis for ar ranlib

---
 bazel/BUILD.redis        | 8 +++++++-
 bazel/ray_deps_setup.bzl | 1 +
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/bazel/BUILD.redis b/bazel/BUILD.redis
index 68e06a75f6..1a8c99d1ff 100644
--- a/bazel/BUILD.redis
+++ b/bazel/BUILD.redis
@@ -43,12 +43,18 @@ make(
 genrule_cmd = select({
     "@platforms//os:osx": """
         unset CC LDFLAGS CXX CXXFLAGS
+        export CC=$(CONDA_CC)
+        export CFLAGS="$(CONDA_CFLAGS)"
+        export AR=$(CONDA_AR)
+        export NM=$(CONDA_NM)
+        export RANLIB=$(CONDA_RANLIB)
+        export SDKROOT="$(CONDA_SDKROOT)"
         tmpdir="redis.tmp"
         p=$(location Makefile)
         cp -p -L -R -- "$${p%/*}" "$${tmpdir}"
         chmod +x "$${tmpdir}"/deps/jemalloc/configure
         parallel="$$(getconf _NPROCESSORS_ONLN || echo 1)"
-        make -s -C "$${tmpdir}" -j"$${parallel}" V=0 CFLAGS="$${CFLAGS-} -DLUA_USE_MKSTEMP -Wno-pragmas -Wno-empty-body"
+        make -s -C "$${tmpdir}" -j"$${parallel}" V=0 CFLAGS="$${CFLAGS-} -DLUA_USE_MKSTEMP -Wno-pragmas -Wno-empty-body" SDKROOT="$${SDKROOT}" AR="$${AR}" RANLIB="$${RANLIB}"
         mv "$${tmpdir}"/src/redis-server $(location redis-server)
         chmod +x $(location redis-server)
         mv "$${tmpdir}"/src/redis-cli $(location redis-cli)
diff --git a/bazel/ray_deps_setup.bzl b/bazel/ray_deps_setup.bzl
index 56c86bdf95..d7703a3f70 100644
--- a/bazel/ray_deps_setup.bzl
+++ b/bazel/ray_deps_setup.bzl
@@ -111,6 +111,7 @@ def ray_deps_setup():
         sha256 = "afd656dbc18a886f9a1cc08a550bf5eb89de0d431e713eba3ae243391fb008a6",
         patches = [
             "@com_github_ray_project_ray//thirdparty/patches:redis-quiet.patch",
+            "@com_github_ray_project_ray//thirdparty/patches:redis-ar-ranlib.patch",
         ],
         workspace_file_content = 'workspace(name = "com_github_antirez_redis")',
     )
-- 
2.43.0

